# Replica rebuild

コントローラは、そのレプリカの1つで障害を検出すると、そのレプリカにエラー状態のマークを付けます。
Longhornボリュームマネージャは、次のように、障害のあるレプリカを再構築するプロセスを開始および調整します。

- Longhornボリュームマネージャは、空のレプリカを作成し、その空のレプリカをレプリカセットに追加するためにコントローラを呼び出します。

- 空白のレプリカを追加するために、コントローラは以下の操作を実行します。
    - すべての読み取りおよび書き込み操作を一時停止します。
    - 空のレプリカをWO（書き込み専用）モードで追加します。
    - 既存のレプリカすべてのスナップショットを作成します。これらのレプリカの先頭には、空白の差分ディスクがあります。
    - すべての読み取りおよび書き込み操作を一時停止します。
    書き込み操作のみが新しく追加されたレプリカにディスパッチされます。
    - 正常なレプリカから空のレプリカに最新の差分ディスクを除くすべてを同期するためのバックグラウンドプロセスを開始します。
    - 同期が完了した後、すべてのレプリカは一貫したデータを持つようになり、ボリュームマネージャは新しいレプリカをRW（読み書き）モードに設定します。
- Longhornボリュームマネージャはコントローラを呼び出して、障害のあるレプリカをそのレプリカセットから削除します。

レプリカを最初から再構築することはあまり効率的ではありません。
障害のあるレプリカから残ったスパースファイルを再利用することで再構築のパフォーマンスを向上させることができます。

